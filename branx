#!/usr/bin/env bash
set -e

# Usage: branx clone {repo}

# Config
config_file="$HOME/.config/branx/env"
declare -A REPOS
WORK_DIR="${HOME}/.local/share/branx"

# Config file expect this:
# REPOS[myrepo]="$HOME/code/myrepo/"
# REPOS[myproject]="https://github.com/myuser/myproject.git"
# WORK_DIR="$HOME/.local/share/branx"

if [ -e "$config_file" ]; then
	source $config_file
fi

# Ensure WORK_DIR exists
mkdir -p "$WORK_DIR"

# Helper functions
random_branch_name() {
	awk -f - <<'EOF'
BEGIN {
    srand()

    n = split("elm fig ivy oak oat poa rue tea yam zea acer aloe ammi arum dill dock fern flax goji hemp hops ilex iris kale leek lens lily lime mint neem okra olea palm pear pine plum reed rice rosa rose ruta sage taro teak teff ulex yuca abies abrus acorn aegle agave ajuga alcea alder alnus anise anona apium areca arjun avena basil birch boldo briza broom buxus cacao canna caper carex carob cedar chard cicer cumin daisy ebury emmer erica fagus ficus gourd grape guava holly hosta inula kenaf kudzu lemon lilac lotus maize malus mango melia melon mesua morus olive onion oryza panax pansy peach peony phlox pisum poppy rubus rumex sabal salix sedum stipa sumac tansy taxus thyme tilia toyon tulip typha ulmus vicia vinca vitex vitis wheat yucca abelia abroma acacia achira acorus actaea adonis akebia albuca alisma allium amomum andira annona arabis aralia arnica aronia asarum atropa azalea bacopa balsam bamboo banana barley bellis betula bidens blitum blumea borago brahmi cactus carrot cassia catnip celery celtis chives cistus citrus cleome clover coffee coleus cordia cosmos costus cotton cowpea crambe crinum crocus croton cuphea cynara dahlia daphne datura derris dodder drimys durian echium elodea endive fennel ferula fescue galium garlic ginger ginkgo hedera hyssop indigo jojoba juncea kochia kutaja lablab lamium laurel laurus lentil lilium locust loquat lovage lupine lychee madder medlar mentha millet mimosa mucuna mukuna myrica myrtle nepeta nettle nutmeg ocimum orchid oxalis papaya pawpaw peanut pepper poplar potato pratia prunus quinoa radish redbud reseda salvia saraca savory scilla secale sesame silene smilax spirea squash stevia tomato turnip urtica violet walnut wasabi willow yarrow zinger zinnia zornia zoysia adenium adianta adlumia aechmea aeonium albizia aletris alfalfa alkanna alpinia anchusa anemone aniseed arbutus arctium ardisia armeria artemia asimina astilbe athelia begonia bogbean bomarea boneset boxwood bracken bryonia buckeye bugbane burdock cabbage calamus calluna caraway carissa cassava catalpa catmint cattail celosia cerasus chebula chervil chicory chirata clarkia clethra coconut comfrey corylus curcuma currant cuscuta cyathus cyperus cypress cytisus damiana daylily dogbane dogwood drosera embelia emblica epazote ephedra festuca filbert freesia fuchsia gazania gentian glycine guduchi gymnema gymnema henbane hickory hordeum humulus icacina ipomoea jasmine juglans juniper katsura lacinia launaea lettuce linaria linseed lithops lobelia lunaria maackia maclura madhuca mahonia manihot monarda moringa mullein mustard nandina nelumbo opuntia oregano oregano oregano pachira paeonia panicum papaver paprika papyrus parsley parsnip perilla petunia phlomis pigweed primula psidium pumpkin quercus rhubarb ricinus rorippa saffron seaweed senecio setaria shallot sinapis solanum sorghum soybean spinach stachys swertia tagetes talinum thistle thlaspi tobacco torenia trefoil vanilla verbena vervain vidanga wolffia", words, " ")

    print words[int(rand() * n) + 1] "-" int(rand() * 90 + 10)
}
EOF
}

resolve_repo() {
	local repo="$1"
	if [[ -v REPOS[$repo] ]]; then
		echo "${REPOS[$repo]}"
	else
		echo "$repo"
	fi
}

# Main
command=$1
shift

case $command in
	clone)
		repo=$(resolve_repo "$1")
		branch_name=$(random_branch_name)

		# Validate local directory is a git repo
		if [[ -d "$repo" ]] && [[ ! -d "$repo/.git" ]]; then
			echo "Error: $repo is not a git repository"
			exit 1
		fi

		# Get repo name (strip .git suffix for remote URLs)
		repo_name=$(basename "$repo" .git)
		target_dir="${WORK_DIR}/${repo_name}/${branch_name}"

		# Ensure WORK_DIR/repo directory exists
		mkdir -p "${WORK_DIR}/${repo_name}"

		# 1. Clone
		git clone "$repo" "$target_dir"
		cd "$target_dir"

		# 2. If cloned from local dir, preserve only the origin remote and sync with it
		if [[ -d "$repo" ]]; then
			origin_url=$(git -C "$repo" remote get-url origin 2>/dev/null) || true
			git remote remove origin 2>/dev/null || true
			if [[ -n "$origin_url" ]]; then
				git remote add origin "$origin_url"
				git fetch origin
				git remote set-head origin --auto
			fi
		fi

		# 3. Switch to new branch from origin/HEAD if available, otherwise from current HEAD
		if git rev-parse --verify origin/HEAD >/dev/null 2>&1; then
			git switch -c "$branch_name" origin/HEAD
		else
			git switch -c "$branch_name"
		fi

		echo "Cloned $repo to $target_dir"
		;;
	*)
		echo "Usage: $0 clone {repo}"
		;;
esac
