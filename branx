#!/usr/bin/env bash
set -e

# Usage: branx clone {repo}

# Config
config_file="$HOME/.config/branx/env"
declare -A REPOS

# Config file expect this:
# REPOS[myrepo]="$HOME/code/myrepo/"
# REPOS[myproject]="https://github.com/myuser/myproject.git"

if [ -e "$config_file" ]; then
	source $config_file
fi

# Helper functions
random_branch_name() {
	awk -f - <<'EOF'
BEGIN {
    srand()

    n = split("allapattah altamonte annamaria apollobeach apopka arcadia arcadiafl atlanta austin aventura avonpark balharbour bayharbor bayshore bayshoregardens belleair bellemeade biscaynepark blackpoint bocaraton bokeelia bonitasprings boston bowlinggreenfl bradenton bradentonbeach brandonfl brickell brooksville brownsvillefl capehaze captiva carrollwood casselberry celebration channelside charlotteharbor chicago chokoloskee clearwater clermont clevelandfl clewiston cocoabeach coconutcreek coopercity copeland coralgables coralsprings coralway cortezfl countrywalk crystalbeach cutler cutlerbay dadecity dallas davie daviefl daytonabeach deepcreek deerfieldbeach delraybeach deltona denver desoto doral duette dunedin eastlake edgewatermiami ellenton elportal englewood estero eureka eustis everglades evergladescity fishhawk flaglerbeach floridacity fontainebleau fortlauderdale fortmyers fortmyersbeach frostproof gainesville gibsonton goldenbeach goldengate goodland goulds groveland hallandale hardeeville hialeah hialeahgardens hollywoodfl holmesbeach homestead homesteadbase houston hudsonfl immokalee indiancreek indianrocks indianshores interbay islamorada jacksonville kendall kendalleast kendalllakes kendallnorth kendallsouth kendallwest kennethcity keybiscayne keylargo keywest kissimmee labelle lakeland lakelandfl lakewales landolakes largo lauderhill leesburg leisurecity libertycity lido lighthousepoint littlehavana longboat longboatkey longwood losangeles lutz madierabeach maitland marathon marcoisland matlacha medley melbourne miami miamibeach miamigardens miamilakes miamishores miamisprings midbeach minneola miramarfl moorehaven mountdora myakka naples naplespark naranja newportrichey newsmirna newyork nokomis northbayvillage northbeach northmiami northmiamibeach northport oaklandfl oaklandpark ocala ochopee ocoee odessa oldsmar ona opaocka opelocka orlando ospoy oviedo palatka palmasola palmcoast palmettobay palmettoestates palmettofl palmharbor parkland parrish pelicanbay pembrokepines philadelphia phoenix pinecrest pineland pinellaspark plantation plantationfl plantcity poinciana pompano ponteinlet portcharlotte portorange princetonfl puntasorda redington redland richmondheights riverview riverviewfl ruskin safetyharbor sanantonio sandiego sanford sanibel sanjose sarasota sarasotabeach seattle sebring seffner seminole siestakey silverpalm southbeach southmiami southtampa southwestranches springhill staugustine stcloud suncity sunbay sunnyisles sunrise surfside sweetwater tallahassee tamarac tampa tarponsprings templeterrace thanosassa thecrossings thefalls threelakes titusville townncountry treasureisland turkeypoint universityfl valrico venice venicefl vineyards virginiagardens wachula wauchula weekiwachee wesleychapel westchase westchesterfl westmiami westonfl westpalmbeach westperrine westtampa wiltonmanors windermere wintergarden winterhaven winterpark wynwood yborcity zephyrhills zolfo zolfosprings aether arc arcana ash ashfall aster atlas auric aurora azura basil basilica bloom cadence caldera calyx cardinal carmine cinder citadel citrine citron cobalt copper coral corona cove crest crimson crystal drift driftwood dune dusk duskflare duskling duskveil duskward echo echofern ember embercore embercove emberfall emberfield emberglass embergrain emberlace emberline emberlynx embermoth emberquartz emberquill embersong emberstrand embertone emberveil emberwake emberwind fable fathom fern fig figment filament flare flux fold frost frostveil frostwind fume gilded glacier gleam glimmer glow glowrift halcyon halo harbor haze helios heliotrope hollow horizon hush hushbloom hushlight hushline hushwind ion isotope ivory lantern latitude lattice lilt linen lumen lumenward lunar magnet marble marrow meridian mirage mirth morrow mosaic mote murmur myrrh mythic nebula nebular night nightfall nightglass nightward noctis nocturne opal opaline orbit orion pearl petal plume pollen prism prismwake pulse pyre quartz radian radiant relic rift rill rune saffron sapphire shadow shadowline shimmer silica silk silver solace solan solstice sonata sonic specter spectral spiral splice starlace stitch stonewake tempest thistle thrum tide tidefall tideglass umbra valencia vapor vault veil vellum velour velvet verdant verdigris whisper zephyr", words, " ")

    print words[int(rand() * n) + 1] "-" int(rand() * 90 + 10)
}
EOF
}

resolve_repo() {
	local repo="$1"
	if [[ -v REPOS[$repo] ]]; then
		echo "${REPOS[$repo]}"
	else
		echo "$repo"
	fi
}

# Main
command=$1
shift

case $command in
	clone)
		repo=$(resolve_repo "$1")
		branch_name=$(random_branch_name)

		# Validate local directory is a git repo
		if [[ -d "$repo" ]] && [[ ! -d "$repo/.git" ]]; then
			echo "Error: $repo is not a git repository"
			exit 1
		fi

		# Get repo name (strip .git suffix for remote URLs)
		repo_name=$(basename "$repo" .git)
		target_dir="${repo_name}-${branch_name}"

		# 1. Clone
		git clone "$repo" "$target_dir"
		cd "$target_dir"

		# 2. If cloned from local dir, preserve only the origin remote
		if [[ -d "$repo" ]]; then
			origin_url=$(git -C "$repo" remote get-url origin 2>/dev/null) || true
			git remote remove origin 2>/dev/null || true
			if [[ -n "$origin_url" ]]; then
				git remote add origin "$origin_url"
			fi
		fi

		# 3. Switch to new branch
		git switch -c "$branch_name"

		echo "Cloned $repo to $target_dir on branch $branch_name"
		;;
	*)
		echo "Usage: $0 clone {repo}"
		;;
esac
